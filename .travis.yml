language: cpp

env:
  global:
    # URL to .zip source release of ICU
    - ICU_SRC_URL=https://github.com/unicode-org/icu/releases/download/release-67-1/icu4c-67_1-src.zip
    # URL to .zip pre-built release of ICU for Windows x86_64
    - ICU_WIN_URL=https://github.com/unicode-org/icu/releases/download/release-67-1/icu4c-67_1-Win64-MSVC2017.zip
    # Docker run command with arguments common to all manylinux builds
    - DOCKER_RUN="docker run --rm -e CCACHE_DIR=/ccache -e PIP_CACHE_DIR=/pipcache -e ICU_SRC_URL -v $HOME/ccache:/ccache -v $HOME/pipcache:/pipcache -v $TRAVIS_BUILD_DIR:/iknow"

jobs:
  include:
    - name: "manylinux2014_aarch64"
      os: linux
      dist: focal
      arch: arm64-graviton2
      virt: lxd
      group: edge
      services: docker
      cache:
        directories:
          - $HOME/ccache
          - $HOME/pipcache  # pip cache for container
          - $HOME/.cache/pip  # pip cache for host
      script: >-
        $DOCKER_RUN quay.io/pypa/manylinux2014_aarch64 /iknow/travis/build_manylinux.sh &&
        PYTHON=python3 travis/deploy.sh
    - name: "manylinux2014_ppc64le"
      os: linux
      dist: focal
      arch: ppc64le
      services: docker
      cache:
        directories:
          - $HOME/ccache
          - $HOME/pipcache
          - $HOME/.cache/pip
      script: >-
        $DOCKER_RUN quay.io/pypa/manylinux2014_ppc64le /iknow/travis/build_manylinux.sh &&
        PYTHON=python3 travis/deploy.sh
    - name: "manylinux2010_x86_64"
      os: linux
      dist: focal
      arch: amd64
      services: docker
      cache:
        directories:
          - $HOME/ccache
          - $HOME/pipcache
          - $HOME/.cache/pip
      script: >-
        $DOCKER_RUN quay.io/pypa/manylinux2010_x86_64 /iknow/travis/build_manylinux.sh &&
        PYTHON=python3 travis/deploy.sh
    - name: "Mac OS X 10.9 x86_64"
      os: osx
      osx_image: xcode11.7
      env: >-
        HOMEBREW_NO_AUTO_UPDATE=1
        MACOSX_DEPLOYMENT_TARGET=10.9
        PATH="/usr/local/opt/ccache/libexec:$PATH"
        CCACHE_DIR="$HOME/ccache"
        PIP_CACHE_DIR="$HOME/pipcache"
        PYINSTALL_DIR="$HOME/.pyenv/versions"
      cache:
        directories:
          - $CCACHE_DIR
          - $PIP_CACHE_DIR
          - $PYINSTALL_DIR
      before_install: eval "$(pyenv init -)"
      install: travis/install_osx.sh
      script: >-
        travis/build_osx.sh &&
        PYTHON=python3.9 travis/deploy.sh
    - name: "Windows x86_64"
      os: windows
      env: >-
        BUILDCACHE_DIR="$HOME/buildcache"
        PIP_CACHE_DIR="$HOME/pipcache"
        PYINSTALL_DIR="$HOME/python"
      cache:
        directories:
          - $BUILDCACHE_DIR
          - $PIP_CACHE_DIR
          - $PYINSTALL_DIR
      install: travis/install_windows.sh
      script: >-
        travis/build_windows.sh &&
        PYTHON="$PYINSTALL_DIR/python.3.9.0-rc2/tools/python.exe" travis/deploy.sh
